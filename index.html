<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>P2P File Share</title>
  <style>
    body { font-family: Arial; margin: 10px; background: #f7f7f7; }
    #home { padding: 10px; border: 1px solid #ccc; background: #fff; }
    #log { border: 1px solid #ccc; padding: 5px; height: 150px; overflow-y: scroll; background: #000; color: #0f0; font-family: monospace; font-size: 12px; }
    #loader { display: none; }
  </style>
</head>
<body>

<div id="home">
  <h3>P2P File Sharing</h3>
  <label><input type="checkbox" id="OpenSendWindow" checked> Send </label>
  <input type="file" id="select_file_to_send"><br><br>
  <input type="text" id="peerIdToConnect" placeholder="Enter Peer ID">
  <button onclick="connectToPeer()">Connect & Send</button>
  <div id="loader"><span class="loader"></span> <b id="progressText">Sending...</b></div>
  <br><br>
  <div><b>Your ID:</b> <span id="myid"></span></div>
</div>

<h4>Log:</h4>
<div id="log">[Log started]</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://unpkg.com/signalhub@5.0.2/signalhub.js"></script>
<script>
let log = msg => {
  const logEl = document.getElementById('log');
  logEl.innerHTML += `<br>${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
};

const hub = signalhub('p2p-fileshare', ['https://signalhub-jccqtwhdwc.now.sh']);
const myId = Math.random().toString(36).substr(2, 9);
document.getElementById("myid").textContent = myId;

let peer;

hub.subscribe(myId).on('data', (signal) => {
  log(`📥 Signal received from peer.`);
  if (!peer) {
    peer = new SimplePeer({ initiator: false, trickle: false });
    setupPeer();
  }
  peer.signal(signal);
});

function connectToPeer() {
  const destId = document.getElementById('peerIdToConnect').value.trim();
  if (!destId) return alert("Enter peer ID");
  peer = new SimplePeer({ initiator: true, trickle: false });
  setupPeer();

  peer.on('signal', data => {
    hub.broadcast(destId, data);
    log(`📢 Signal sent to ${destId}`);
  });
}

function setupPeer() {
  peer.on('connect', () => {
    log('✅ Peer connected!');
    const fileInput = document.getElementById('select_file_to_send');
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        peer.send(JSON.stringify({ name: file.name, buffer: reader.result }));
        log(`📤 File sent: ${file.name}`);
      };
      reader.readAsArrayBuffer(file);
    }
  });

  peer.on('data', data => {
    const received = JSON.parse(data);
    const blob = new Blob([new Uint8Array(received.buffer)]);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = received.name;
    a.click();
    log(`✅ File received: ${received.name}`);
  });

  peer.on('error', err => log(`❌ Error: ${err}`));
  peer.on('close', () => log('🔌 Peer disconnected.'));
}
</script>

</body>
</html>
